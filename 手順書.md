# 🚀 AWS無料インフラ構築 完全手順書

## 📋 目次
1. [前提条件](#前提条件)
2. [AWSアカウント準備](#awsアカウント準備)
3. [ローカル環境セットアップ](#ローカル環境セットアップ)
4. [プロジェクト準備](#プロジェクト準備)
5. [デプロイ実行](#デプロイ実行)
6. [動作確認](#動作確認)
7. [監視設定確認](#監視設定確認)
8. [トラブルシューティング](#トラブルシューティング)
9. [リソース削除](#リソース削除)

---

## 1. 前提条件

### 必要なもの
- **AWSアカウント** (無料枠対応)
- **クレジットカード** (認証用、課金されません)
- **メールアドレス** (アラート通知用)
- **インターネット接続**

### 推奨環境
- **OS**: macOS, Windows, Linux
- **メモリ**: 4GB以上
- **ディスク**: 1GB以上の空き容量

---

## 2. AWSアカウント準備

### 2.1 AWSアカウント作成
1. [AWS公式サイト](https://aws.amazon.com/jp/)にアクセス
2. 「アカウントを作成」をクリック
3. 以下の情報を入力：
   - **メールアドレス**
   - **パスワード**
   - **AWSアカウント名**

### 2.2 連絡先情報入力
1. **アカウントタイプ**: 個人
2. **氏名**: 実名を入力
3. **電話番号**: 携帯電話番号
4. **国/地域**: 日本
5. **住所**: 現在の住所

### 2.3 支払い情報入力
1. **クレジットカード情報**を入力
   - カード番号
   - 有効期限
   - セキュリティコード
   - カード名義人
2. **請求先住所**を入力

### 2.4 アカウント確認
1. **電話番号認証**:
   - 自動音声またはSMSで認証コードを受信
   - 認証コードを入力
2. **メール認証**:
   - 送信されたメールのリンクをクリック

### 2.5 サポートプラン選択
- **無料サポートプラン**を選択
- 「アカウントの作成を完了」をクリック

---

## 3. ローカル環境セットアップ

### 3.1 AWS CLIインストール

#### macOS (Homebrew)
```bash
# Homebrewのインストール（未インストールの場合）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# AWS CLIインストール
brew install awscli
```

#### Windows
```bash
# 公式インストーラーをダウンロード
# https://awscli.amazonaws.com/AWSCLIV2.msi
# ダウンロードしたファイルを実行
```

#### Linux (Ubuntu)
```bash
# AWS CLIインストール
sudo apt update
sudo apt install awscli
```

### 3.2 Terraformインストール

#### macOS (Homebrew)
```bash
brew install terraform
```

#### Windows
```bash
# Chocolateyを使用
choco install terraform

# または公式バイナリをダウンロード
# https://developer.hashicorp.com/terraform/downloads
```

#### Linux (Ubuntu)
```bash
# Terraformリポジトリの追加
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list

# Terraformインストール
sudo apt update
sudo apt install terraform
```

### 3.3 Node.jsインストール

#### macOS (Homebrew)
```bash
brew install node
```

#### Windows
```bash
# 公式インストーラーをダウンロード
# https://nodejs.org/
```

#### Linux (Ubuntu)
```bash
# NodeSourceリポジトリの追加
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -

# Node.jsインストール
sudo apt-get install -y nodejs
```

### 3.4 インストール確認
```bash
# 各ツールのバージョン確認
aws --version
terraform --version
node --version
npm --version
```

---

## 4. プロジェクト準備

### 4.1 AWS認証情報設定
```bash
# AWS認証情報の設定
aws configure

# 以下の情報を入力：
# AWS Access Key ID: [AWSコンソールで取得]
# AWS Secret Access Key: [AWSコンソールで取得]
# Default region name: ap-northeast-1
# Default output format: json
```

### 4.2 AWS認証情報の取得方法

#### IAMユーザー作成
1. AWSコンソールにログイン
2. **IAM**サービスに移動
3. **ユーザー** → **ユーザーを作成**
4. ユーザー名: `terraform-user`
5. **アクセスキー**にチェック
6. **次へ**をクリック

#### 権限設定
1. **ポリシーを直接アタッチ**
2. 以下のポリシーを検索して選択：
   - `AdministratorAccess` (開発用)
   - または個別のポリシー（本番環境推奨）
3. **次へ** → **ユーザーの作成**

#### アクセスキー取得
1. 作成したユーザーをクリック
2. **セキュリティ認証情報**タブ
3. **アクセスキーを作成**
4. **アクセスキーID**と**シークレットアクセスキー**をコピー

### 4.3 プロジェクトディレクトリ確認
```bash
# 現在のディレクトリを確認
pwd
# 出力: /Users/yoh/form_portfolio

# ファイル一覧を確認
ls -la
```

### 4.4 必要なファイルの確認
以下のファイルが存在することを確認：
- `index.html`
- `styles.css`
- `script.js`
- `admin.html`
- `admin-styles.css`
- `admin-script.js`
- `lambda-function.js`
- `script-aws.js`
- `admin-script-aws.js`
- `terraform/main.tf`
- `deploy.sh`
- `README-AWS.md`

---

## 5. デプロイ実行

### 5.1 デプロイスクリプトの実行権限付与
```bash
# 実行権限を付与
chmod +x deploy.sh
```

### 5.2 デプロイの実行
```bash
# デプロイスクリプトを実行
./deploy.sh
```

### 5.3 デプロイ中の操作

#### 1. ツール確認
```
📋 必要なツールを確認中...
✅ 必要なツールが確認できました
```

#### 2. AWS認証情報確認
```
🔐 AWS認証情報を確認中...
✅ AWS認証情報が確認できました
```

#### 3. Lambda関数パッケージ作成
```
📦 Lambda関数のパッケージを作成中...
✅ Lambda関数のパッケージが作成されました
```

#### 4. メールアドレス入力
```
📧 アラート通知用メールアドレスを設定してください:
メールアドレス: your-email@example.com
```

#### 5. Terraformデプロイ
```
🏗️  AWSインフラをデプロイ中...
Initializing the backend...
Initializing provider plugins...
Terraform has been successfully initialized!
...
Apply complete! Resources: 15 added, 0 changed, 0 destroyed.
```

#### 6. フロントエンド更新
```
🌐 フロントエンドファイルを更新中...
✅ フロントエンドファイルが更新されました
```

#### 7. S3アップロード
```
📤 S3バケットにファイルをアップロード中...
✅ ファイルのアップロードが完了しました
```

### 5.4 デプロイ完了
```
🎉 デプロイが完了しました！

📊 デプロイ情報:
   🌐 CloudFront URL: https://d1234567890abc.cloudfront.net
   🗄️  S3 Website URL: http://form-portfolio-website-abc123.s3-website-ap-northeast-1.amazonaws.com
   🔌 API Gateway URL: https://abc123.execute-api.ap-northeast-1.amazonaws.com/prod/form

📝 管理者ページ:
   https://d1234567890abc.cloudfront.net/admin.html
   パスワード: Password

🚨 監視・アラート設定:
   - CloudWatchアラーム: 無料枠使用量の監視
   - SNS通知: メールでのアラート配信
   - 予算アラート: $1/月の予算設定
   - 無料枠の80%使用時に通知

💰 コスト情報:
   この構成はAWS無料枠の範囲内で動作します
   - S3: 5GBまで無料
   - CloudFront: 1TB/月まで無料
   - Lambda: 100万リクエスト/月まで無料
   - API Gateway: 100万リクエスト/月まで無料
   - DynamoDB: 25GB + 25WCU/25RCUまで無料
   - CloudWatchアラーム: 10個まで無料
```

---

## 6. 動作確認

### 6.1 メインフォームの確認
1. **ブラウザでアクセス**:
   ```
   https://[cloudfront-domain]
   ```

2. **フォーム入力テスト**:
   - 氏名: `テスト太郎`
   - 生年月日: `1990-01-01`
   - マイナンバー: `123456789012`
   - メールアドレス: `test@example.com`
   - 電話番号: `090-1234-5678`
   - 都道府県: `東京都`
   - 個人情報の取り扱い: チェック

3. **送信テスト**:
   - 「送信する」ボタンをクリック
   - 成功メッセージが表示されることを確認

### 6.2 管理者ページの確認
1. **管理者ページにアクセス**:
   ```
   https://[cloudfront-domain]/admin.html
   ```

2. **ログイン**:
   - パスワード: `Password`
   - ログイン後、データ一覧が表示されることを確認

3. **機能テスト**:
   - **更新ボタン**: データを最新化
   - **エクスポートボタン**: CSVファイルをダウンロード
   - **ログアウトボタン**: セッション終了

### 6.3 API動作確認
```bash
# API Gatewayのテスト
curl -X POST https://[api-gateway-url] \
  -H "Content-Type: application/json" \
  -d '{
    "name": "APIテスト",
    "birthdate": "1990-01-01",
    "mynumber": "123456789012",
    "email": "api@test.com",
    "phone": "090-1234-5678"
  }'
```

---

## 7. 監視設定確認

### 7.1 CloudWatchアラーム確認
1. **AWSコンソール**にログイン
2. **CloudWatch**サービスに移動
3. **アラーム**を確認
4. 以下のアラームが作成されていることを確認：
   - `form-portfolio-lambda-invocations`
   - `form-portfolio-api-requests`
   - `form-portfolio-dynamodb-read-capacity`
   - `form-portfolio-dynamodb-write-capacity`
   - `form-portfolio-s3-bucket-size`

### 7.2 SNS通知確認
1. **SNS**サービスに移動
2. **トピック**を確認
3. `form-portfolio-billing-alerts`が作成されていることを確認
4. **サブスクリプション**でメールアドレスが登録されていることを確認

### 7.3 予算アラート確認
1. **Billing**サービスに移動
2. **Budgets**を確認
3. `form-portfolio-monthly-budget`が作成されていることを確認

### 7.4 メール通知テスト
1. 設定したメールアドレスに確認メールが届いていることを確認
2. スパムフォルダも確認

---

## 8. トラブルシューティング

### 8.1 よくある問題と解決方法

#### AWS認証情報エラー
```bash
# エラー: Unable to locate credentials
aws configure
# 認証情報を再設定
```

#### Terraform初期化エラー
```bash
# エラー: Failed to get existing workspaces
cd terraform
terraform init -reconfigure
```

#### Lambda関数エラー
```bash
# CloudWatchログを確認
aws logs describe-log-groups
aws logs filter-log-events --log-group-name "/aws/lambda/form-portfolio-handler"
```

#### S3アップロードエラー
```bash
# バケット名を確認
aws s3 ls
# 手動でアップロード
aws s3 cp index.html s3://[bucket-name]/
```

#### CloudFront配信エラー
```bash
# キャッシュを無効化
aws cloudfront create-invalidation --distribution-id [distribution-id] --paths "/*"
```

### 8.2 ログの確認方法

#### CloudWatchログ
```bash
# Lambda関数のログ
aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/form-portfolio"

# ログイベントの確認
aws logs filter-log-events --log-group-name "/aws/lambda/form-portfolio-handler" --start-time $(date -d '1 hour ago' +%s)000
```

#### API Gatewayログ
```bash
# API Gatewayのログ
aws logs describe-log-groups --log-group-name-prefix "API-Gateway-Execution-Logs"
```

### 8.3 パフォーマンス確認

#### レスポンス時間確認
```bash
# API Gatewayのレスポンス時間
curl -w "@curl-format.txt" -o /dev/null -s https://[api-gateway-url]
```

#### 使用量確認
```bash
# Lambda関数の使用量
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Invocations \
  --dimensions Name=FunctionName,Value=form-portfolio-handler \
  --start-time $(date -d '1 day ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date +%Y-%m-%dT%H:%M:%S) \
  --period 86400 \
  --statistics Sum
```

---

## 9. リソース削除

### 9.1 完全削除
```bash
# Terraformでリソースを削除
cd terraform
terraform destroy

# 確認メッセージが表示されたら「yes」を入力
```

### 9.2 手動削除（Terraformが失敗した場合）

#### S3バケット削除
```bash
# バケット内のオブジェクトを削除
aws s3 rm s3://[bucket-name] --recursive

# バケットを削除
aws s3 rb s3://[bucket-name]
```

#### Lambda関数削除
```bash
# Lambda関数を削除
aws lambda delete-function --function-name form-portfolio-handler
```

#### DynamoDBテーブル削除
```bash
# DynamoDBテーブルを削除
aws dynamodb delete-table --table-name form-data-table
```

#### CloudWatchアラーム削除
```bash
# アラームを削除
aws cloudwatch delete-alarms --alarm-names \
  form-portfolio-lambda-invocations \
  form-portfolio-api-requests \
  form-portfolio-dynamodb-read-capacity \
  form-portfolio-dynamodb-write-capacity \
  form-portfolio-s3-bucket-size
```

### 9.3 削除確認
```bash
# リソースが削除されたことを確認
aws s3 ls
aws lambda list-functions
aws dynamodb list-tables
aws cloudwatch describe-alarms
```

---

## 📞 サポート

### 問題が発生した場合
1. **エラーメッセージ**をコピー
2. **実行したコマンド**を記録
3. **AWSコンソール**のスクリーンショットを撮影
4. **詳細な状況**を説明

### 参考資料
- [AWS公式ドキュメント](https://docs.aws.amazon.com/)
- [Terraform公式ドキュメント](https://www.terraform.io/docs)
- [CloudWatch料金](https://aws.amazon.com/jp/cloudwatch/pricing/)

---

## 🎉 完了！

お疲れさまでした！AWS無料インフラ構築が完了しました。

### 作成されたもの
- ✅ **Webアプリケーション**: 個人情報入力フォーム
- ✅ **サーバーレスAPI**: Lambda + API Gateway
- ✅ **データベース**: DynamoDB
- ✅ **CDN**: CloudFront
- ✅ **監視システム**: CloudWatch + SNS
- ✅ **インフラコード**: Terraform

### ポートフォリオとして活用
このプロジェクトは以下のスキルを証明します：
- AWSサービス全般の理解
- サーバーレスアーキテクチャ設計
- インフラのコード化（IaC）
- 監視・運用技術
- コスト最適化

**月額0円で運用可能な本格的なWebアプリケーション**が完成しました！🎊 